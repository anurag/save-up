# Dev

up:
  diesel migration run

up-test:
  DATABASE_URL=$DATABASE_URL_TEST diesel migration run

setup-test:
  DATABASE_URL=$DATABASE_URL_TEST diesel setup

schema:
  diesel print-schema > src/models/schema.rs

build:
  cargo build

run: build
  cargo run

start:
  cargo watch -x run

test:
  APP_ENV=test cargo test

# Utils

# Shell into the Docker release container
sh:
  docker run -i -t --entrypoint /bin/bash kic-api

# Deployment

build-release:
  docker build \
    -f Dockerfile.release \
    -t kic-api .

  docker run -it \
    -v $PWD:/volume \
    -v cargo-cache:/root/.cargo \
    kic-api \
    cargo build -Z unstable-options --release --out-dir /volume/bin

  rm bin/build-script-build
  rm bin/build-script-main

date = `date +%Y-%m-%d-%H:%M`

deploy-release:
  aws deploy push \
    --application-name KicApi \
    --description "Update" \
    --s3-location s3://kic-api-deploys/kic-{{date}}.zip \
    --source bin
