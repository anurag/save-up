# In order to have the shared folder during compilation
# We need to compile from the parent directory
build-directory directory:
	docker run \
		--rm \
		-it \
		-v $PWD/{{directory}}:/volume/{{directory}} \
		-v $PWD/shared:/volume/shared \
		-v cargo-cache:/root/.cargo \
		clux/muslrust:stable \
		cargo build --release --manifest-path ./{{directory}}/Cargo.toml

copy-binary directory bin_name:
	mkdir -p ./bin/{{bin_name}}/
	cp {{directory}}/target/x86_64-unknown-linux-musl/release/{{bin_name}} ./bin/{{bin_name}}/

build-graphql:
	just build-directory graphql
	just copy-binary graphql graphql
	just copy-binary graphql graphql_pub
	just copy-binary graphql migrate

build-mail:
	just build-directory mail
	just copy-binary mail mail

# Generate SAM template.yml, so we can test this locally
# THIS DOESN'T VALIDATE
generate-sam:
	sls sam export --output ./sam.yml

sam-validate:
	sam validate -t template.yaml

sam-local:
	sam local start-api \
		-t template.yaml \
		-p 4010 \
		--skip-pull-image

try:
	curl \
		--request POST \
		--header "Content-Type: application/json" \
		--data '{"query": "{__schema{types{name}}}", "variables": {}, "operationName": null}' \
		http://127.0.0.1:4010/graphql

# Didn't work yet
sam-try-mail:
	sam local invoke "Mail" --event mail/src/fixtures/sns-event-invite.json

# Didn't work yet
sls-try-mail:
	sls invoke -f mail --path mail/src/fixtures/sns-event-invite.json

invoke-migration:
	curl \
		--request POST \
		http://127.0.0.1:4010/migrate

# package:
# 	sam package \
# 		--template-file template.yaml \
# 		--s3-bucket kic-api \
# 		--output-template-file packaged.yaml

# deploy:
# 	sam deploy \
# 		--template-file ./packaged.yaml \
# 		--stack-name kic-api \
# 		--capabilities CAPABILITY_IAM

deploy:
	sls deploy
