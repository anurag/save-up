start:
	cargo run

dp-setup:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel setup

db-gen name:
	diesel migration generate {{name}}

db-up:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel migration run
	DATABASE_URL=$DATABASE_URL_TEST diesel migration run

db-down:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel migration revert
	DATABASE_URL=$DATABASE_URL_TEST diesel migration revert

dp-setup-test:
	DATABASE_URL=$DATABASE_URL_TEST diesel setup

schema:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel print-schema > src/models/schema.rs

test:
	APP_ENV=test cargo test

build-directory directory:
	docker run \
		--rm \
		-it \
		-v $PWD/{{directory}}:/volume/{{directory}} \
		-v $PWD/shared:/volume/shared \
		-v cargo-cache:/root/.cargo \
		clux/muslrust:stable \
		cargo build --release --manifest-path ./{{directory}}/Cargo.toml

copy-binary directory bin_name:
	mkdir -p ./bin/{{bin_name}}/
	cp {{directory}}/target/x86_64-unknown-linux-musl/release/{{bin_name}} ./bin/{{bin_name}}/

deploy:
	now --public
	
