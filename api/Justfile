migration-up:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel migration run

migration-down:
	DATABASE_URL=$DATABASE_URL_LOCAL diesel migration revert

dp-test-create:
	DATABASE_URL=$DATABASE_URL_TEST diesel setup

migration-test-down:
	DATABASE_URL=$DATABASE_URL_TEST diesel migration revert

schema:
	diesel print-schema > src/models/schema.rs

test:
	APP_ENV=test cargo test

build:
	docker run \
		--rm \
		-it \
		-v $PWD:/volume \
		-v cargo-cache:/root/.cargo \
		clux/muslrust:stable \
		cargo build --release
	mkdir -p bin/
	cp target/x86_64-unknown-linux-musl/release/graphql bin/

try:
	curl \
		--request POST \
		--header "Content-Type: application/json" \
		--data '{"query": "{__schema{types{name}}}", "variables": {}, "operationName": null}' \
		http://127.0.0.1:4010/graphql

package:
	sam package \
		--template-file template.yaml \
		--s3-bucket kic-api \
		--output-template-file packaged.yaml

deploy:
	sam deploy \
		--template-file ./packaged.yaml \
		--stack-name kic-api \
		--capabilities CAPABILITY_IAM
